# Global variables
variables:
    MOD_VER_CMD: "modver info.json"


# Make sure we have these variables set before each script
before_script:
- 'export MOD_VER=$($MOD_VER_CMD)'
- 'export MOD_NAME=${CI_PROJECT_NAME}_${MOD_VER}'
- 'export MOD_FILE=${MOD_NAME}.zip'
# We also need a symbolic link to the current dir so we can create valid factorio mod packs
- 'ln -s . $MOD_NAME'


# Make a test mod package and run tests on factorio headless 
tests_build:
    stage: test
    script: 
    - '# Applying patches...'
    - 'git checkout -- control.lua'
    - 'echo "require \"tests.module\"" >> control.lua'
    - 'echo "require \"tests.prototypes\"" >> control.lua'
    
    - '# Creating mod package...'
    - 'zip -r $MOD_FILE $MOD_NAME/tests $MOD_NAME/graphics $MOD_NAME/locale $MOD_NAME/prototypes $MOD_NAME/script-locale $MOD_NAME/scripts $MOD_NAME/data.lua $MOD_NAME/data-updates.lua $MOD_NAME/data-final-fixes.lua $MOD_NAME/control.lua $MOD_NAME/config.lua $MOD_NAME/info.json'
    
    - '# Copying mod package to factorio mods location'
    - 'mv $MOD_FILE /var/factorio/factorio/mods'
    
    - '# Testing save creation...'
    - 'cd /var/factorio/factorio'
    - 'echo "Removing old factorio save..."'
    - 'rm -f saves/dytech-core.zip'
    - 'echo "Creating new factorio save..."'
    - './bin/x64/factorio --create saves/dytech-core.zip'
    
    - '# Running unit tests...'
    - 'echo "Running factorio..."'
    - './test-runner.moon'


# Make a release mod package
release_build: 
    stage: deploy
    when: on_success
    only: 
    - tags
    script:
    - 'Creating mod package...'
    artifacts: 
        name: "${CI_PROJECT_NAME}_$($MOD_VER_CMD)"
        paths: 
        - '$MOD_NAME/info.json'
        - '$MOD_NAME/config.lua'
        - '$MOD_NAME/data.lua'
        - '$MOD_NAME/data-updates.lua'
        - '$MOD_NAME/data-final-fixes.lua'
        - '$MOD_NAME/scripts/'
        - '$MOD_NAME/script-locale/'
        - '$MOD_NAME/prototypes/'
        - '$MOD_NAME/graphics/'
        - '$MOD_NAME/locale/'
        - '$MOD_NAME/tests/'
